<!DOCTYPE html>
<html lang="en">
	<head>
		<title>AR DEMO</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link type="text/css" rel="stylesheet" href="main.css">
		<style>
			* {
			  margin: 0;
			  padding: 0;
			}
		  </style>
	</head>
	<body>
		<video id="video" style="position: absolute; z-index: -1; 
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		object-fit: fill;" >
		</video>
		<div>
		  <button id="capture" style="position: absolute;">打开相机</button>
		</div>
		<script>
		  document.getElementById('capture').addEventListener('click', function () {
			getRealMedia()
		  })

		function getRealMedia() {
			if (!navigator.mediaDevices.getUserMedia) {
				Toast('您的系统暂不支持AR导航');
				return;
			}

			navigator.mediaDevices.enumerateDevices()
			.then(devices => {
				var videoDevices = [];
				devices.forEach(function (device) {
					if (device.kind == "videoinput") {
						videoDevices.push(device.deviceId)
					}
				});
				console.log(videoDevices)
				var constraints = {
					width: 375,
					height: 500,
					deviceId: {
						exact: videoDevices[videoDevices.length - 1]
					}
				};
				return navigator.mediaDevices.getUserMedia({
					video: constraints
				});

			})
			.then(stream => {
				let video = document.getElementById('video');
				video.srcObject = stream;
				video.play();
				stopId = stream.getTracks()[stream.getTracks().length - 1];
			})
			.catch(e => console.error(e));
		}
		</script>

		<script type="module">
		
			import * as THREE from './three.module.js';
			import { FirstPersonCameraControl } from './FirstPersonCameraControl.js';
			import { GLTFLoader } from './GLTFLoader.js';
			import { RGBELoader } from './RGBELoader.js';
			import { EquirectangularToCubeGenerator } from './EquirectangularToCubeGenerator.js';
			import { PMREMGenerator } from './PMREMGenerator.js';
			import { PMREMCubeUVPacker } from './PMREMCubeUVPacker.js';
			import { OrbitControls } from './OrbitControls.js';

			var camera, scene, renderer, controls, loader;

			// 平面坐标x,y 对应三维场景的x，z
			// y固定为1.5米 
			var objData = [
				{
					name: '手机1.glb',
					position: {
						x: 27,
						y: 1.5,
						z: 8
					}
				},
				{
					name: '手机2.glb',
					position: {
						x: 27,
						y: 1.5,
						z: 11
					}
				},				
			]
			init();
			animate();

			function init() {
				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.01, 300 );
				// camera.position.set( 3,1,7 );
				camera.position.x = -50;
				camera.position.y = 1.5;
				camera.position.z = 9;
				camera.lookAt(-49.9, 1.5, 9)

				scene = new THREE.Scene();
				scene.background = null;

				var light = new THREE.AmbientLight( 0xffffff, 1);
				scene.add( light );
				var directionalLight = new THREE.DirectionalLight( 0xffffff, 1 );
				directionalLight.position.set( 0, 0, -1 );
				scene.add( directionalLight );

				//
				renderer = new THREE.WebGLRenderer( {
					antialias: true,
					alpha:true
				});
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.body.appendChild( renderer.domElement );

				//
				controls = new FirstPersonCameraControl( camera, renderer.domElement );
				controls.enabled = true;	
				
				// controls = new OrbitControls( camera, renderer.domElement );
				// controls.enableDamping = true; // an animation loop is required when either damping or auto-rotation are enabled
				// controls.dampingFactor = 0.05;
				// controls.screenSpacePanning = false;
				// controls.minDistance = 0.01;
				// controls.maxDistance = 50000;

				window.addEventListener( 'resize', onWindowResize, false );

				loader = new GLTFLoader().setPath( 'models/glb/' );
				for (var i = 0; i < objData.length; i++) {
					(function(i) {
						var obj = objData[i]
						loader.load( obj.name, function ( gltf ) {
							gltf.scene.position.set(obj.position.x,  1.5, obj.position.z)
							gltf.scene.scale.set(0.01, 0.01, 0.01);
							// gltf.scene.rotateY(Math.PI / 2);
							scene.add( gltf.scene );
							})						
					})(i)
				}
	 		}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
			}

			function animate() {
				requestAnimationFrame( animate );

				for (var i = 0; i < scene.children.length; i++) {
					if (scene.children[i].type == "Scene") {
						scene.children[i].lookAt(camera.position)
					}
				}
				controls.update();
				renderer.render( scene, camera );
			}
		</script>
	</body>
</html>
